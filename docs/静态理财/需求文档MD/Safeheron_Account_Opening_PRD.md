# 产品需求文档：Safeheron 钱包自动开户功能

## 前言
> **核心目标**：解决用户注册后无充值地址无法进行理财入金的问题。通过接入 Safeheron 托管服务，实现用户点击即开户，自动分配区块链充值地址，降低用户入金门槛。

---

## 一、 版本信息

| 版本号 | 创建日期 | 审核人 |
| :--- | :--- | :--- |
| V1.0.0 | 2026-01-08 | 待定 |

---

## 二、 变更日志

| 时间 | 版本号 | 变更人 | 主要变更内容 |
| :--- | :--- | :--- | :--- |
| 2026-01-08 | V1.0.0 | Eric | 文档初始化：新增 Safeheron 开户引导流程 |

---

## 三、 文档说明

### 名词解释

| 术语 / 缩略词 | 说明 |
| :--- | :--- |
| **Safeheron** | 本项目使用的第三方数字资产托管服务商，负责生成钱包地址和资产安全保管。 |
| **开户 (Account Opening)** | 特指在业务系统中为用户分配唯一的 Safeheron 钱包充值地址的过程。只有开户后，用户才能进行充值（入金）。 |
| **未开户状态** | 用户已注册登录 APP/Web，但尚未触发生成 Safeheron 钱包地址的状态。 |
| **充值地址** | 区块链上的收款地址（如 USDT-TRC20 地址），用户向此地址转账即视为充值成功。 |

---

## 四、 需求背景

### 产品 / 数据现状
目前用户注册账号后，系统并未默认立即分配 Safeheron 钱包地址（为了节省托管资源或合规流程）。用户在进入“资产页面”或点击“申购理财产品”时，如果没有充值地址，将无法进行后续操作，导致转化率流失。

### 用户调研
*   **痛点**：新手用户不懂“托管”概念，如果系统提示“未绑定钱包”且无引导，用户会感到困惑并流失。
*   **期望**：用户希望像开通微信零钱一样简单，点击一个按钮，系统自动处理好所有后台逻辑，直接展示收款码。

### 竞品分析

| 主要信息 | 关键结论 |
| :--- | :--- |
| **某头部理财 APP** | 用户注册后默认不开户，点击充值时弹出“激活账户”弹窗，3秒内完成地址分配，体验流畅。 |
| **竞品 B** | 注册即生成地址，但造成大量空置地址浪费资源。 |

**结论**：采用“按需开户”模式，但在 UI 上必须做到**无感或低感知**，将“开户”包装为“激活理财账户”或“获取充值地址”。

---

## 五、 需求范围

1.  **状态检测**：全链路（首页、理财页、资产页）检测用户是否已分配 Safeheron 地址。
2.  **引导 UI**：针对未开户用户，在关键路径设计强引导弹窗或占位图。
3.  **API 对接**：后端对接 Safeheron 的 `Create Wallet Account` 接口。
4.  **异常处理**：处理网络超时、Safeheron 服务不可用等情况的 UI 反馈。

---

## 六、 功能详细说明

### 1. 产品流程图

> 逻辑简述：
> 1. 用户访问需资金交互页面。
> 2. 前端判断 `user.has_wallet`。
> 3. False -> 弹出“开通资金账户”引导。
> 4. 用户点击“立即开通”。
> 5. 后端请求 Safeheron API -> 获取地址 -> 存入数据库 -> 更新用户状态。
> 6. 前端轮询或接收成功回调 -> 展示充值地址/继续之前的操作。

### 2. 功能模块详述

#### 模块一：资产中心/充值入口拦截

| 序号 | 功能点 | 详细说明 | 交互逻辑 |
| :--- | :--- | :--- | :--- |
| 1.1 | **状态判断** | 用户进入【资产中心】或点击【充值】按钮时，系统需判断 `is_account_opened` (是否已开户)。 | 后端接口返回字段标识用户状态。 |
| 1.2 | **未开户展示** | 若状态为“未开户”，资产数值区域显示“--”，下方操作按钮显示“激活账户”或“获取地址”。<br>或者直接弹窗提示（见 1.3）。 | 页面不应显示报错，而是显示引导状态。 |
| 1.3 | **开户引导弹窗** | 当用户有明确意图（点击充值、点击申购）时，若未开户，强制弹出模态框。<br>**标题**：开通理财资金账户<br>**文案**：为了保障您的资金安全，请先激活您的专属数字资产托管账户。<br>**按钮**：【立即开通】 | 点击按钮后进入 Loading 状态，按钮文字变为“正在开通...”，不可重复点击。 |

#### 模块二：Safeheron 对接与开户执行 - **P0 修复：幂等性防护**

| 序号 | 功能点 | 详细说明 | 交互逻辑 |
| :--- | :--- | :--- | :--- |
| 2.1 | **幂等性检查 (P0 关键)** | 请求前，检查是否已有 SUCCESS 状态的开户记录。<br>如果有，直接返回已有的 wallet_id 和地址，不再调用 Safeheron。 | 检查 `wallet_creation_request` 表：<br>- 若状态为 SUCCESS：返回已有地址<br>- 若状态为 CREATING：返回"开户中，请稍候"<br>- 若状态为 FAILED：允许重试（新request_id） |
| 2.2 | **请求开户** | 用户点击"立即开通"后，前端调用后端 `POST /api/wallet/create` 接口。<br>**前端生成 request_id (UUID)**，随请求发送。 | 全局 Loading 遮罩，防止用户误触。<br>同一 request_id 多次点击只发送一次请求。 |
| 2.3 | **后端逻辑（含幂等性）** | 1. 检查用户 KYC 状态（如需）。<br>2. **查询 wallet_creation_request 表，检查该用户是否已有记录**。<br>3. 如已有 SUCCESS 记录，返回原结果。<br>4. 如已有 CREATING 记录，返回"进行中"。<br>5. 否则，创建新的 CREATING 记录。<br>6. 调用 Safeheron API 创建 Wallet Account。<br>7. 获取生成的 Coin Address。<br>8. 更新记录状态为 SUCCESS，存储 wallet_id 和地址。<br>9. 绑定至本地 User 表（is_account_opened = true）。 | **必须保证幂等性**，避免重复创建钱包。 |
| 2.4 | **开户成功反馈** | 接口返回成功后：<br>1. 关闭 Loading。<br>2. Toast 提示"账户开通成功"。<br>3. 自动刷新页面，展示出充值地址二维码。 | 体验要丝滑，最好无需用户手动刷新。 |
| 2.5 | **开户失败处理** | 若 Safeheron 接口超时或报错：<br>1. 关闭 Loading。<br>2. 更新 wallet_creation_request 状态为 FAILED，记录错误信息。<br>3. 弹窗提示"系统繁忙，请稍后重试"。<br>4. 提供【重试】按钮（同一 request_id 可重试）。<br>5. 如重试次数 > 3，提示"请联系客服"。 | 错误文案需友好，不要展示 "Error 500" 等技术术语。 |

### 3. 交互原型说明 (文字版)

*   **场景 A：未开户用户点击“资产”**
    *   **页面**：显示“总资产 0.00”。
    *   **核心区域**：出现一个卡片 [ 🔒 激活您的资金账户 ]，点击后触发开户接口。
*   **场景 B：未开户用户点击“申购产品”**
    *   **动作**：点击“立即申购”。
    *   **拦截**：弹出 BottomSheet（底部弹窗）。
    *   **内容**：
        *   ICON：安全盾牌图标
        *   Title：请先开通资金账户
        *   Desc：系统将为您分配专属 Safeheron 托管地址，安全可信。
        *   Button：[ 立即开通 ] (主色调高亮)

---

## 七、 非功能需求

1.  **安全性**：
    *   与 Safeheron 的通信必须使用服务端签名，严禁在前端直接调用 Safeheron API。
    *   开户接口需增加频率限制（Rate Limiting），防止恶意刷地址攻击。
2.  **性能**：
    *   开户过程（从点击到展示地址）期望在 **3秒** 内完成。若超过 5秒，需给出“正在配置中，请稍候查看”的反馈，改为后台异步处理。
3.  **兼容性**：
    *   H5、iOS、Android 端样式保持一致。

---

## 八、 埋点设计

| 事件ID (Event ID) | 事件名称 | 参数名 (Key) | 参数说明 | 触发时机 |
| :--- | :--- | :--- | :--- | :--- |
| `click_activate_wallet` | 点击激活钱包 | `source_page` | 来源页面 (assets/product_detail) | 用户点击“立即开通”按钮时 |
| `wallet_create_result` | 钱包创建结果 | `status` | success / fail | 后端接口返回结果时 |
| `wallet_create_duration`| 钱包创建耗时 | `time_ms` | 毫秒数 | 接口请求开始到结束的时间差 |

---

## 九、 项目规划

*   **阶段一（1天）**：UI 设计与 Safeheron 接口调试。
*   **阶段二（2天）**：前后端联调，完成状态判断与地址生成逻辑。
*   **阶段三（0.5天）**：测试异常情况（如 Safeheron 宕机时的用户提示）。

## 附录
*   Safeheron API 文档：[链接]
*   UI 设计稿：[Figma 链接]
