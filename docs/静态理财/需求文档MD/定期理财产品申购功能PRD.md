# 产品需求文档：定期理财产品申购功能

## 前言
> **核心目标**：为用户提供从查看定期理财产品详情到完成申购的全链路功能，支持用户利用理财账户余额进行资产增值，并确保在申购过程中对额度、余额、状态进行严格校验，保障业务合规与用户体验。

---

## 一、 版本信息

| 版本号 | 创建日期 | 审核人 |
| :--- | :--- | :--- |
| V1.0.0 | 2026-01-08 | 待定 |

---

## 二、 变更日志

| 时间 | 版本号 | 变更人 | 主要变更内容 |
| :--- | :--- | :--- | :--- |
| 2026-01-08 | V1.0.0 | Eric | 文档初始化：根据 UI 原型梳理定期理财申购流程 |

---

## 三、 文档说明

### 名词解释

| 术语 / 缩略词 | 说明 |
| :--- | :--- |
| **T日** | 申购日，即用户操作申购的当天。 |
| **起息日** | 开始计算利息的日期，通常为 T+1 日。 |
| **赎回日** | 产品到期，本金和利息返还到账户的日期。 |
| **划转** | 资金在“资金账户”与“理财账户”之间互转的操作。 |
| **自动申购** | 产品到期后，系统自动将本息再次申购同类产品的功能（复利投资）。 |

---

## 四、 需求背景

### 产品 / 数据现状
用户在理财大厅看到感兴趣的定期产品后，需要一个详情页来深入了解产品规则（如起息时间、限额），并需要一个流畅的确认流程来完成下单。

### 竞品分析
*   **交互惯例**：主流竞品（如欧易、币安）均采用“列表 -> 详情 -> 弹窗/半屏页确认”的路径。
*   **关键体验**：在确认页实时计算“预计收益”和“本次最大可投金额”是提升体验的关键。

---

## 五、 需求范围

1.  **产品详情页**：展示产品核心要素（收益率、期限）、资金流转时间轴、用户对该产品的历史申购记录。
2.  **申购确认页（弹窗）**：输入金额、校验规则（余额、限额）、展示预计收益、签署协议。
3.  **状态流转**：处理申购成功、失败、处理中等状态反馈。

---

## 六、 功能详细说明

### 1. 业务流程图

> **主流程**：
> 用户进入定期理财列表 -> 点击产品卡片 -> **进入产品详情页** -> 点击“立即申购” -> **弹出申购确认窗** -> 输入金额 -> 勾选协议 -> 点击确认 -> **提交订单** -> 后台校验扣款 -> 反馈结果。

### 2. 功能模块详述

#### 模块一：定期产品详情页 (Product Detail Page)

**页面目标**：让用户清晰了解“我买了什么”、“什么时候能拿到钱”、“我还剩多少额度”。

| 序号 | 字段/区域 | 详细逻辑说明 | 交互/展示 |
| :--- | :--- | :--- | :--- |
| 1 | **账户概览** | 展示用户在定期理财账户的总体情况：<br>1. **投资定期总额** (USDT)<br>2. **昨日利息** (USDT) | 顶部固定展示，数据脱敏（支持隐藏）。 |
| 2 | **产品信息卡** | 1. **产品名称**：如 "USDT超高收益7日理财"。<br>2. **年化收益率 (APY)**：如 "7%"。<br>3. **期限**：如 "7天"。<br>4. **进度条**：展示产品总额度的售卖进度（已购/总额）。 | 核心视觉区域，重点突出 APY。 |
| 3 | **时间轴 (Timeline)** | 展示资金流转的关键节点：<br>1. **申购日**：当前时间/T日。<br>2. **起息日**：T+1日 00:00 或 12:00（视配置）。<br>3. **赎回日**：起息日 + 产品期限。<br>4. **到账时间**：通常为赎回日次日 12:00。 | 图形化展示，箭头连接各节点。 |
| 4 | **交易限制数据** | 1. **起购数量**：单笔最低金额（如 100 USDT）。<br>2. **产品总额度**：该产品池子总共可卖多少。<br>3. **剩余可购**：**核心逻辑**。<br>   计算公式：`Min(个人总上限 - 个人已持仓, 产品剩余总额度)`。<br>   *注：若用户未登录，显示 "--"；若剩余可购 < 起购数量，显示 0。*<br><br>**P0 更新（冻结机制）**：<br>- 显示的"可用余额"已经扣除了**提现冻结金额**<br>- 公式：`可用余额 = balance - frozen_balance`<br>- 最大可购 = `Min(可用余额, 个人限额, 产品额度)`<br>- 提现待确认时，冻结金额对申购不可用 | 以列表形式展示详细参数，确保用户知道冻结状态。 |
| 5 | **我的申购记录** | 仅展示**当前用户**在**当前产品**下的历史订单。<br>字段：申购时间、币种、数量、年化、预期利息、昨日利息、状态（计息中/已赎回等）。 | 底部列表，支持横向滚动查看更多字段。 |
| 6 | **底部操作栏** | **按钮状态流转**：<br>- **立即申购**：当前时间在售卖期内，且额度充足。<br>- **已售罄**：产品剩余额度为0。<br>- **暂未开始**：当前时间 < 开售时间。<br>- **已结束**：当前时间 > 停售时间。 | 底部悬浮，主色调按钮。点击触发“申购确认弹窗”。 |

#### 模块二：申购确认弹窗 (Subscription Confirmation Modal)

**页面目标**：完成交易前的最后确认，输入金额并校验风险。

| 序号 | 功能点 | 详细逻辑说明 | 交互逻辑 |
| :--- | :--- | :--- | :--- |
| 1 | **基础信息** | 回显产品名称、年化收益率、期限。 | 顶部标题栏。 |
| 2 | **金额输入框** | 用户输入申购数量。<br>**限制**：<br>- 只能输入数字。<br>- 小数位精度受币种配置限制。<br>- 实时校验：输入值 vs 可用余额 vs 限额。 | 输入时实时计算"预计收益"。 |
| 3 | **全部(Max)按钮** | 点击后自动填充"最大可买数量"。<br>**最大可买公式** = `Min(账户可用余额, 个人剩余限额, 单笔最大限额, 每日剩余限额)`。 | 位于输入框右侧。 |
| 4 | **可用余额与划转** | 1. 显示当前理财账户可用余额。<br>2. 提供"划转"链接，点击跳转至资金划转页面（资金账户->理财账户）。 | 若余额不足，余额文字变红提示。 |
| 5 | **校验提示** | 当输入金额不满足条件时，在输入框下方显示红字错误提示：<br>- "账户可用余额不足"<br>- "单次申购最小数量为 X USDT"<br>- "单次申购最大数量为 Y USDT"<br>- "已超过本次最大可投数量" | 优先级：余额 > 单次限额 > 累积限额。 |
| 6 | **时间轴确认** | 再次展示：申购日(Today) -> 起息日(Date) -> 赎回日(Date)。 | 确保用户知晓资金冻结周期。 |
| 7 | **预计收益计算** | **公式**：`输入金额 * 年化收益率 / 365 * 期限天数`。<br>若未输入或输入非法，显示 "--"。 | 实时变动，精确到币种最小单位。 |
| 8 | **自动申购开关 (P1 增强说明)** | 开关组件。开启后，到期本息自动复投（续期）。<br><br>**P1 增强 - 用户说明文案**：<br>- **复投说明**："开启后，到期本息将自动作为本金继续投资同类产品，无需手动操作"<br>- **失败处理**："如果到期时产品已下架或额度不足，系统会自动将本息转入您的账户，您可重新选择产品申购"<br>- **消息通知**："续期成功/失败会通过 App 消息、邮件等方式通知您，请及时查看"<br>- **前置条件**："需完成 KYC 认证后方可开启"<br>- **取消说明**："您可在订单详情页随时关闭自动续期，到期后本息直接转入账户"<br><br>*注：产品下架 → 自动降级为赎回；额度不足 → 自动降级为赎回。* | 默认关闭，推荐开启以获得更高复利收益。 |
| 9 | **协议签署** | 勾选框："我已阅读并同意《定期理财服务协议》"。 | 必须勾选才能点击确认按钮。 |
| 10 | **确认按钮 (P0 修复：重复提交防护)** | 点击后提交订单。<br>**P0 防护机制**：<br>1. 前端生成 `request_id` (UUID)，存储到 sessionStorage。<br>2. 相同 request_id 在 30 秒内不重复发送请求（去重）。<br>3. 按钮进入 Loading 状态，显示 "提交中..."，置灰不可点。<br>4. 设置 30 秒超时，超时后提示 "订单提交处理中，请勿重复提交，可在订单记录查看结果"。<br>5. 后端使用 request_id 进行幂等检查，同一 request_id 只扣款一次。<br>6. 成功 -> 关闭弹窗，进入结果页/刷新详情页。<br>7. 失败 -> Toast 提示错误原因，按钮恢复可点。 | **关键说明**：<br>- 防止用户在弱网或超时时多次点击导致多笔扣款<br>- 前后端配合实现完整的幂等性保证<br>- 用户可安心重试，不会导致重复扣款 |

---

## 七、 异常流程与边界条件 - **P0 修复：重复提交防护**

1.  **余额不足**：用户点击"确认"时，若余额不足（可能在输入期间被其他操作扣除），接口返回错误，前端提示"余额不足，请充值或划转"。
2.  **额度被抢光**：在用户输入金额期间，产品刚好售罄。点击确认时，接口报错"产品已售罄"，前端引导用户查看其他产品。
3.  **重复提交 (P0 关键修复)**：
    *   **场景**：用户在弱网环境下点击"确认申购"，5秒内没收到响应，用户误以为失败，再次点击。
    *   **防护机制**：
        - 前端使用 `request_id` (UUID) 标识每次申购请求
        - 相同 `request_id` 在 30 秒内只发送一次 HTTP 请求（浏览器级去重）
        - 后端也记录 `request_id`，相同 request_id 的请求只扣款一次（服务端幂等）
        - 用户重试时，系统自动返回第一次申购的结果（如果还在处理中）
    *   **用户体验**：显示 "订单提交处理中，请勿重复提交，可在订单记录查看结果"，避免用户惊慌
4.  **网络异常**：点击确认后超时，显示"结果处理中，请稍后在订单记录查看"，避免用户重复点击造成重复扣款。
5.  **未登录**：在详情页点击"立即申购"，跳转至登录页，登录成功后跳回该详情页。

---

## 八、 埋点设计

| 事件ID | 事件名称 | 参数 | 说明 |
| :--- | :--- | :--- | :--- |
| `page_view_product_detail` | 访问产品详情页 | `product_id`, `product_name` | 统计产品热度 |
| `click_buy_now` | 点击立即申购 | `product_id`, `status` | 统计转化漏斗第一步 (status=normal/sold_out) |
| `click_confirm_subscription` | 点击确认申购 | `product_id`, `amount`, `auto_invest` | 统计下单意愿及是否开启自动续期 |
| `subscription_result` | 申购结果 | `result` (success/fail), `fail_reason` | 统计成功率及失败原因 |
| `click_transfer_entry` | 点击划转入口 | `source` (confirmation_page) | 统计因余额不足的引流情况 |

---

## 十、 P1 项详细设计（开发前必读）

### 10.1 自动续期详细逻辑（系统设计文档配合）

本 PRD 与《System_Design_Wealth_Account.md》的 Q3 自动续期设计相辅相成，涵盖以下内容：

**关键点**：
- ✅ 自动续期时检查产品是否仍在销售（status 必须为 募集中）
- ✅ 检查产品剩余额度是否足以支持新订单（sold_quota + amount + interest <= total_quota）
- ✅ 如产品不满足条件，**自动降级为赎回**，本息转入用户账户
- ✅ 用户将收到消息通知"续期失败"，可重新申购其他产品
- ✅ 用户可在订单详情页查看历史续期结果

**新订单起息时间线**（P1 新增说明）：
- ✅ 新订单也遵循 **T+1 起息规则**（保证流程一致性）
- ✅ 自动续期在赎回日创建新订单
- ✅ **新订单申购日 = 赎回日**，**起息日 = 赎回日 + 1**
- ✅ 用户体验：自动续期过程中有 **1 天的资金空闲期**（接受范围内）
  - 本期本息在赎回日到账
  - 新订单在赎回日 + 1 才开始计息
  - **必须在《定期理财服务协议》中明确说明此1天间隔，告知用户这不属于产品损失，而是合规流程所必需**

### 10.2 利息派发时间轴（详细版）

**P1 新增 - 利息派发的完整时间线**：

```
申购日（T 日）
  ↓
T+1 日 00:00 - 起息日开始
  ↓
T+1 ~ T+N 日 23:59 - 计息阶段
  每日 23:59 执行计息脚本：
    daily_interest = amount * apy / 365
    INSERT INTO wealth_interest_record
    (order_id, amount, type=1, date=TODAY)
  ↓
T+N 日 23:59 - 锁定利息（不再计提）
  UPDATE wealth_order SET interest_expected = SUM(daily_interest)
  ↓
T+N+1 日 00:00 - 赎回日（本息到账）
  1. 用户 WEALTH 账户 +amount +interest_expected
  2. 系统 SYSTEM_WEALTH 账户 -amount -interest_expected
  3. 记录流水（REDEEM_PRINCIPAL + INTEREST_PAYOUT）
  4. 如 auto_renew=1，不入账，而是创建新订单
  ↓
T+N+1 日 - 用户可查看订单详情
  已赎回状态，显示：
  - 本金：1000 USDT
  - 利息：19.18 USDT
  - 总收益：1019.18 USDT
  - 年化回报率：7%
```

**自动续期时的新订单时间线**（P1 新增示例）：

假设首个订单在 1月30日中午申购，期限7天。赎回日为 2月6日 00:00。如用户开启自动续期，流程如下：

```
【第一期订单】
申购日：1月30日 12:00
起息日：1月31日 00:00
赎回日：2月6日 00:00（本息到账）
  ↓
【自动续期触发】2月6日 00:00
  1. 第一期本息到账账户：本金 1000 USDT + 利息 19.18 USDT
  2. 系统创建第二期新订单（申购日 = 2月6日）
  ↓
【第二期订单】
申购日：2月6日 00:00（自动创建）
【1天资金空闲期】：2月6日 00:00 ~ 2月6日 23:59（新订单尚未起息）
起息日：2月7日 00:00（新订单开始计息）
赎回日：2月13日 00:00（本息到账）

说明：
- 用户在2月6日赎回日能立即查看第一期的本息
- 新订单申购日 = 赎回日，遵循T+1起息规则（一致性）
- 2月6日全天本息在账但未计息，属于合规必需的交割时间（非产品损失）
```

**用户在申购确认页看到的"预计收益"计算**：
```
预计收益 = 输入金额 * 年化收益率 / 365 * 期限天数

例：投资 1000 USDT，年化 7%，期限 7 天
预计收益 = 1000 * 0.07 / 365 * 7 = 1.34 USDT
```

**到期赎回后的实际利息**：
系统每日计息，赎回日前一天锁定总利息。由于每日精确计息，实际利息可能与预计利息略有差异（≤ ±0.01）。

### 10.3 订单详情页设计 (P1 新增：Order Detail Management)

| 序号 | 模块 | 说明 | 交互 |
|-----|-----|------|------|
| 1 | **订单基本信息** | 产品名称、申购时间、申购金额、年化收益率、期限 | 只读展示 |
| 2 | **收益计算** | 预期总利息、已派发利息、未派发利息（带计算公式） | 只读展示 |
| 3 | **时间轴** | 申购日 → 起息日 → 赎回日 → 到账日 | 可视化展示 |
| 4 | **订单状态** | 处理中 / 计息中 / 已赎回 / 续期中 / 已续期 / 失败 | 彩色标签 |
| 5 | **自动续期设置 (P1 新增)** | <br>**当 status = 计息中**：<br>- 显示当前设置："已开启自动续期"或"未开启"<br>- 提供【修改】按钮，可切换设置（到期前任意时刻可改）<br>- 说明："修改设置将在本订单到期后生效"<br><br>**当 status = 已赎回/续期失败**：<br>- 显示历史设置："申购时已开启自动续期"<br>- 显示续期结果："自动续期成功，新订单号 #XXX"或"自动续期失败，本息已转入账户"<br>- 如是续期失败，显示【重新申购】按钮 | 动态按钮 |
| 6 | **操作区** | <br>**进行中**：【查看流水】【关闭自动续期】【提前赎回*】<br>**已赎回**：【查看流水】【查看新订单】<br><br>*备注：提前赎回需产品规则允许 | 根据状态展示 |
| 7 | **通知偏好** | 用户可设置：订单即将到期时是否接收提醒、续期成功/失败时是否接收通知 | 可选设置 |

### P1 自动续期失败提示示例

**续期失败 - 产品下架**：
```
⚠️ 自动续期失败
您的订单于 [日期] 到期，因产品已下架，
未能自动续期。本期本息（本金 1000 USDT + 利息 19.18 USDT）
已于 [日期] 转入您的理财账户。

【查看账户】【重新申购其他产品】
```

**续期失败 - 额度不足**：
```
⚠️ 自动续期失败
您的订单于 [日期] 到期，因产品额度已售罄，
未能自动续期。本期本息（本金 1000 USDT + 利息 19.18 USDT）
已于 [日期] 转入您的理财账户。

【查看类似产品】【手动重新申购】
```

**续期成功**：
```
✅ 自动续期成功
您的订单于 [日期] 自动续期为新订单 #12345，
本期本息（1019.18 USDT）已作为本金投资，预期收益 19.37 USDT。

【查看新订单详情】【查看历史订单】
```

---

## 十一、 P0 修复总结（关键安全与合规要求）

本 PRD 已整合以下高风险修复，**必须在开发前完成**：

### P0.1 重复提交防护机制
- ✅ 前端：生成 UUID `request_id`，30秒内相同 request_id 不重复发送
- ✅ 后端：在 `idempotency_record` 表中记录每个 request_id，同一 request_id 只扣款一次
- ✅ 用户体验：30秒超时时显示"处理中，请稍后查看订单记录"
- **影响**：防止弱网环境下的多笔扣款

### P0.2 并发超卖防护（系统设计文档更新）
- ✅ 使用 `SELECT FOR UPDATE` 锁定账户和产品行（读阶段锁定）
- ✅ 乐观锁版本号机制（UPDATE 时检查版本号）
- ✅ 两层防护：SELECT FOR UPDATE + 乐观锁
- **影响**：防止高并发下的额度超卖

### P0.3 系统账户与账务闭环（系统设计文档更新）
- ✅ 创建 `user_id = -1` 的系统账户（type = 'SYSTEM_WEALTH'）
- ✅ 申购时：用户账户 -X，系统账户 +X（双向记账）
- ✅ 赎回时：用户账户 +Y，系统账户 -Y（保持平衡）
- ✅ 每小时对账脚本：Σ(用户理财账户) = 系统账户余额
- ✅ 失衡时：立即冻结所有理财业务，发送紧急告警
- **影响**：确保账务永不失衡，满足金融审计要求

### P0.4 Safeheron 幂等性防护（Safeheron PRD 更新）
- ✅ 前端生成 `request_id`，每次开户请求携带
- ✅ 后端检查 `wallet_creation_request` 表
- ✅ 已有 SUCCESS 记录：直接返回已有钱包地址
- ✅ 已有 CREATING 记录：返回"进行中，请稍候"
- ✅ 避免向 Safeheron 创建重复钱包
- **影响**：防止多次调用 Safeheron 导致的账户混乱

### P0.5 划转幂等性防护（系统设计文档更新）
- ✅ 前端生成全局唯一的 `transfer_id`
- ✅ 后端在 `transfer_record` 表中记录每笔划转的完整链路
- ✅ 相同 `transfer_id` 的请求幂等：直接返回第一次的结果
- ✅ 异常时用户可查询划转记录了解状态
- **影响**：防止网络中断导致的重复划转

---

## 附录 - P0 修复架构关系图

```
申购请求 (含 request_id)
  ↓
[前端去重] 30秒内相同request_id不发送
  ↓
[后端幂等检查] idempotency_record
  ↓
  ├─→ 已 SUCCESS → 返回已有 order_id（不扣款）
  ├─→ 已 PROCESSING → 返回"处理中"
  └─→ 未记录 → 继续流程
  ↓
[事务开始] REPEATABLE_READ 隔离级别
  ↓
[SELECT FOR UPDATE] 锁定 account & wealth_product 行
  ↓
[乐观锁验证] balance 检查 & version 匹配
  ↓
[双向记账]
  ├─→ 用户 WEALTH 账户 -X
  └─→ 系统 SYSTEM_WEALTH 账户 +X
  ↓
[创建订单] wealth_order
  ↓
[记录流水] account_journal（用户 + 系统两条）
  ↓
[更新幂等] idempotency_record = SUCCESS
  ↓
[提交事务] COMMIT
  ↓
[每小时对账] reconcile_wealth_accounts()
  └─→ Σ(user_balance) = system_balance ?
      否 → 告警 + 冻结业务
```

---
*   UI 设计稿：[Figma 链接]
*   接口文档：`POST /api/wealth/regular/subscribe`
