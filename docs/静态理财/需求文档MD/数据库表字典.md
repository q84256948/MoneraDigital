# 数据库表字典

**版本**: V1.1 (PostgreSQL适配版)
**日期**: 2026-01-09
**系统**: MoneraDigital Asset & Wealth System (PostgreSQL Edition)

---

## 目录

1. [核心账户系统表](#核心账户系统表)
2. [幂等性与重复提交防护表](#幂等性与重复提交防护表)
3. [理财产品系统表](#理财产品系统表)
4. [提现系统表](#提现系统表)
5. [审计和风控表](#审计和风控表)

---

## 核心账户系统表

### 1. account（用户资产账户表）

**用途**: 记录用户在不同业务线下的资金余额，支持冻结机制

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 账户ID |
| user_id | BIGINT | UK_1 | 用户ID |
| type | VARCHAR(16) | UK_1 | 账户类型: FUND(资金), WEALTH(理财), SYSTEM_WEALTH(系统账户) |
| currency | VARCHAR(8) | UK_1 | 币种: USDT, BTC, ETH等 |
| balance | NUMERIC(65, 30) | NOT NULL | 账户余额（已扣款，不含冻结） |
| frozen_balance | NUMERIC(65, 30) | NOT NULL | 冻结余额（提现等待中的冻结金额） |
| version | BIGINT | NOT NULL | 乐观锁版本号（每次变更+1） |
| created_at | TIMESTAMPTZ | DEFAULT NOW | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW | 更新时间 |

**关键说明**:
- `balance` 和 `frozen_balance` 的关系：用户可用余额 = balance - frozen_balance
- `frozen_balance` 用于提现流程的冻结机制，防止金额被其他操作使用
- `version` 字段实现乐观锁，防止并发超扣
- 系统账户固定为 user_id = -1，type = 'SYSTEM_WEALTH'
- **精度升级**: 使用 `NUMERIC(65, 30)` 以支持 ETH (18 decimals) 等高精度代币

**索引**:
- uk_user_type_currency: 唯一约束，确保每个用户每种账户类型每种币种只有一条记录
- idx_user_id: 用户查询
- idx_frozen_balance: 冻结余额查询

---

### 2. account_journal（账务流水表）

**用途**: 记录所有资金变动，不可篡改，用于对账和审计

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 流水ID |
| serial_no | VARCHAR(64) | UK | 全局唯一业务流水号（幂等性键） |
| user_id | BIGINT | Index | 用户ID（冗余字段，方便查询） |
| account_id | BIGINT | Index | 变动的账户ID |
| amount | NUMERIC(65, 30) | NOT NULL | 变动金额（正数增加，负数减少） |
| balance_snapshot | NUMERIC(65, 30) | NOT NULL | 变动后的余额快照（用于快速对账） |
| biz_type | VARCHAR(32) | Index | 业务类型: TRANSFER_IN, SUBSCRIBE_DEDUCT, REDEEM_ADD, INTEREST, WITHDRAWAL_SUCCESS等 |
| ref_id | BIGINT | Index | 关联业务ID（如wealth_order.id） |
| created_at | TIMESTAMPTZ | DEFAULT NOW | 创建时间 |

**关键说明**:
- 采用复式记账思想，每笔交易可能产生多条流水（用户账户 + 系统账户）
- serial_no 确保幂等性，相同流水号不会重复记录
- balance_snapshot 用于快速对账，无需重新计算

---

### 3. account_reconciliation（账户对账记录表）

**用途**: 记录定期对账任务的执行结果

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 对账记录ID |
| check_time | TIMESTAMPTZ | Index | 对账时间 |
| type | VARCHAR(32) | Index | 对账类型: BALANCE_MATCH, JOURNAL_VERIFY等 |
| user_total | NUMERIC(65, 30) | | 用户账户总额 |
| system_balance | NUMERIC(65, 30) | | 系统账户余额 |
| difference | NUMERIC(65, 30) | | 差异金额 |
| status | VARCHAR(32) | Index | 对账结果: SUCCESS, WARNING, CRITICAL |
| description | TEXT | | 对账描述或告警信息 |
| created_at | TIMESTAMPTZ | DEFAULT NOW | 创建时间 |

**关键说明**:
- 每小时执行一次全量对账
- 如果 difference != 0，立即告警并冻结理财业务

---

### 4. user_kyc（用户KYC认证表）

**用途**: 记录用户身份认证信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | KYC记录ID |
| user_id | BIGINT | UK | 用户ID |
| identity_type | VARCHAR(32) | | 证件类型: PASSPORT, IDCARD, DRIVER_LICENSE等 |
| identity_number | VARCHAR(128) | | 证件号码 |
| first_name | VARCHAR(128) | | 名 |
| last_name | VARCHAR(128) | | 姓 |
| date_of_birth | DATE | | 出生日期 |
| country_code | VARCHAR(8) | | 国家代码 |
| status | VARCHAR(32) | Index | 状态: PENDING, VERIFYING, APPROVED, REJECTED, EXPIRED |
| verified_at | TIMESTAMPTZ | Index | 认证通过时间 |
| expires_at | TIMESTAMPTZ | Index | 认证过期时间 |
| created_at | TIMESTAMPTZ | DEFAULT NOW | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW | 更新时间 |

---

## 幂等性与重复提交防护表

### 5. idempotency_record（幂等性记录表）

**用途**: 防止重复提交导致的多笔扣款，用于订购、划转等所有资金操作

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 记录ID |
| user_id | BIGINT | UK_1 | 用户ID |
| request_id | VARCHAR(128) | UK_1 | 客户端生成的唯一请求ID (UUID) |
| biz_type | VARCHAR(32) | UK_1 | 业务类型: SUBSCRIBE, TRANSFER, REDEEM, WITHDRAWAL等 |
| status | VARCHAR(32) | Index | 状态: PROCESSING(处理中), SUCCESS(成功), FAILED(失败) |
| result_data | JSONB | | 成功时返回的结果数据（如order_id） |
| error_message | VARCHAR(255) | | 失败时的错误信息 |
| created_at | TIMESTAMPTZ | DEFAULT NOW | 请求创建时间 |
| completed_at | TIMESTAMPTZ | | 请求完成时间 |
| ttl_expire_at | TIMESTAMPTZ | Index | 记录过期时间（通常为24小时后） |

**关键说明**:
- 相同 user_id + request_id + biz_type 的请求视为幂等操作
- 若 PROCESSING 状态超过 30 秒未更新，前端可重新发起请求（新的 request_id）
- 过期记录每日清理（TTL）

---

### 6. wallet_creation_request（Safeheron钱包创建请求表）

**用途**: 防止重复向Safeheron创建钱包账户

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 记录ID |
| user_id | BIGINT | UK | 用户ID（唯一，同一用户只能创建一次） |
| request_id | VARCHAR(128) | UK | 本次创建请求ID |
| status | VARCHAR(32) | Index | 状态: PENDING, CREATING, SUCCESS, FAILED |
| safeheron_wallet_id | VARCHAR(128) | | Safeheron返回的钱包ID |
| coin_address | VARCHAR(256) | | 生成的区块链地址 |
| error_message | VARCHAR(255) | | 创建失败的原因 |
| retry_count | INT | | 重试次数 |
| created_at | TIMESTAMPTZ | DEFAULT NOW | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW | 更新时间 |

---

### 7. transfer_record（资金划转记录表）

**用途**: 追踪用户资金账户与理财账户间的划转

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 记录ID |
| user_id | BIGINT | Index | 用户ID |
| transfer_id | VARCHAR(64) | UK | 全局唯一划转ID（业务维度） |
| from_account_id | BIGINT | | 转出账户ID |
| to_account_id | BIGINT | | 转入账户ID |
| amount | NUMERIC(65, 30) | NOT NULL | 划转金额 |
| status | VARCHAR(32) | Index | 状态: PENDING, SUCCESS, FAILED |
| created_at | TIMESTAMPTZ | DEFAULT NOW | 创建时间 |
| completed_at | TIMESTAMPTZ | | 完成时间 |

**关键说明**:
- transfer_id 由前端生成并传递，便于业务方追踪
- 幂等性：相同 transfer_id 的请求返回同样结果

---

## 理财产品系统表

### 8. wealth_product（理财产品配置表）

**用途**: 记录理财产品的基本信息和销售进度

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 产品ID |
| title | VARCHAR(128) | NOT NULL | 产品名称（如"USDT 7日高息"） |
| description | TEXT | | 产品描述 |
| currency | VARCHAR(8) | Index | 申购币种 |
| apy | NUMERIC(10, 4) | NOT NULL | 年化收益率（如0.0700表示7%） |
| duration | INT | NOT NULL | 期限（天数） |
| min_amount | NUMERIC(65, 30) | NOT NULL | 起购金额 |
| max_amount | NUMERIC(65, 30) | NOT NULL | 单人限额 |
| total_quota | NUMERIC(65, 30) | NOT NULL | 总额度 |
| sold_quota | NUMERIC(65, 30) | NOT NULL | 已售额度（乐观锁更新） |
| status | SMALLINT | Index | 状态: 1-待上架, 2-募集中, 3-已售罄, 4-已结束 |
| auto_renew_allowed | BOOLEAN | | 是否允许自动续期: false-否, true-是 |
| created_at | TIMESTAMPTZ | DEFAULT NOW | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW | 更新时间 |

---

### 9. wealth_order（理财申购订单表）

**用途**: 记录用户与产品的契约关系

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 订单ID |
| user_id | BIGINT | Index | 用户ID |
| product_id | BIGINT | Index | 产品ID |
| amount | NUMERIC(65, 30) | NOT NULL | 申购本金 |
| principal_redeemed | NUMERIC(65, 30) | | 已赎回本金 |
| interest_expected | NUMERIC(65, 30) | NOT NULL | 预期总利息（快照字段，申购时计算好） |
| interest_paid | NUMERIC(65, 30) | NOT NULL | 已派发利息 |
| start_date | DATE | NOT NULL | 起息日 |
| end_date | DATE | Index | 到期赎回日（用于定时任务扫描） |
| auto_renew | BOOLEAN | | 是否开启自动续期: false-否, true-是 |
| status | SMALLINT | Index | 状态: 0-处理中, 1-持有中(计息), 2-已赎回/结束, 3-失败, 4-已续期 |
| renewed_from_order_id | BIGINT | Index | 续期来源的订单ID（如果是续期产品） |
| renewed_to_order_id | BIGINT | Index | 续期到的新订单ID |
| created_at | TIMESTAMPTZ | DEFAULT NOW | 申购时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW | 更新时间 |

**关键说明**:
- interest_expected 是快照字段，申购时计算好，不会变化
- end_date 用于定时任务扫描到期订单
- renewed_from_order_id 和 renewed_to_order_id 用于链接续期订单

---

### 10. wealth_interest_record（每日计息/发放记录表）

**用途**: 记录每日产生的利息或最终发放的利息流水

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 记录ID |
| order_id | BIGINT | Index | 关联订单ID |
| user_id | BIGINT | Index | 用户ID（冗余字段，方便查询） |
| amount | NUMERIC(65, 30) | NOT NULL | 当次产生/发放的利息 |
| type | SMALLINT | Index | 类型: 1-每日计提(仅记录), 2-实际发放(入账) |
| date | DATE | Index | 归属日期 |
| created_at | TIMESTAMPTZ | DEFAULT NOW | 创建时间 |

**关键说明**:
- type=1: 每日计提，仅记录，不入账
- type=2: 实际发放，已入账到用户账户

---

## 提现系统表

### 11. withdrawal_address_whitelist（提币地址白名单表）

**用途**: 管理用户的提币地址，支持地址验证

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 地址ID |
| user_id | BIGINT | Index | 用户ID |
| address_alias | VARCHAR(255) | NOT NULL | 用户自定义别名 |
| chain_type | VARCHAR(32) | Index | 区块链类型: TRC20/ERC20/BEP20等 |
| wallet_address | VARCHAR(255) | NOT NULL | 实际钱包地址（加密存储） |
| verified | BOOLEAN | Index | 是否已验证: false-否, true-是 |
| verified_at | TIMESTAMPTZ | | 验证时间 |
| verification_method | VARCHAR(32) | | 验证方式: SMS/EMAIL/GOOGLE |
| is_deleted | BOOLEAN | | 软删除标记: false-未删除, true-已删除 |
| created_at | TIMESTAMPTZ | DEFAULT NOW | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW | 更新时间 |

**关键说明**:
- wallet_address 需要加密存储
- verified 标记地址是否已通过二次验证
- 软删除：逻辑删除，历史订单仍可查看该地址

---

### 12. withdrawal_request（提现请求记录表）

**用途**: 记录提现请求，支持幂等性检查

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 请求ID |
| user_id | BIGINT | Index | 用户ID |
| request_id | VARCHAR(64) | UK | UUID，用于幂等性检查 |
| status | VARCHAR(32) | Index | 状态: PROCESSING, SUCCESS, FAILED |
| error_code | VARCHAR(64) | | 错误代码 |
| error_message | TEXT | | 错误信息 |
| created_at | TIMESTAMPTZ | DEFAULT NOW | 创建时间 |

---

### 13. withdrawal_order（提现订单表）

**用途**: 记录完整的提现信息和状态

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 订单ID |
| user_id | BIGINT | Index | 用户ID |
| amount | NUMERIC(65, 30) | NOT NULL | 提现金额 |
| network_fee | NUMERIC(65, 30) | | 矿工费 |
| platform_fee | NUMERIC(65, 30) | | 平台手续费 |
| actual_amount | NUMERIC(65, 30) | | 实际到账金额 |
| chain_type | VARCHAR(32) | Index | 区块链类型: TRC20/ERC20/BEP20等 |
| coin_type | VARCHAR(32) | NOT NULL | 币种: USDT/USDC等 |
| to_address | VARCHAR(255) | NOT NULL | 目标地址（加密存储） |
| safeheron_order_id | VARCHAR(64) | UK | Safeheron订单ID |
| transaction_hash | VARCHAR(255) | Index | 区块链交易哈希 |
| status | ENUM(...) | Index | 状态: PENDING, VERIFYING, SENT, CONFIRMING, CONFIRMED, COMPLETED, FAILED, CANCELLED, TIMEOUT |
| created_at | TIMESTAMPTZ | DEFAULT NOW | 创建时间 |
| sent_at | TIMESTAMPTZ | | 发送至链的时间 |
| confirmed_at | TIMESTAMPTZ | | 链上确认时间 |
| completed_at | TIMESTAMPTZ | | 完成时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW | 更新时间 |

**关键说明**:
- 8个状态完整覆盖提现全生命周期
- actual_amount = amount - network_fee - platform_fee
- safeheron_order_id 用于与Safeheron对账

---

### 14. withdrawal_verification（提现二次验证记录表）

**用途**: 记录地址验证的详细信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 验证记录ID |
| user_id | BIGINT | Index | 用户ID |
| withdrawal_order_id | BIGINT | Index | 提现订单ID |
| verification_method | VARCHAR(32) | NOT NULL | 验证方式: SMS/EMAIL/GOOGLE |
| verification_code | VARCHAR(255) | | 验证码（加密存储） |
| attempts | INT | | 尝试次数 |
| max_attempts | INT | | 最大尝试次数（默认3） |
| verified | BOOLEAN | Index | 是否通过验证: false-否, true-是 |
| verified_at | TIMESTAMPTZ | | 验证通过时间 |
| expires_at | TIMESTAMPTZ | | 验证码过期时间 |
| created_at | TIMESTAMPTZ | DEFAULT NOW | 创建时间 |

**关键说明**:
- 验证码有效期10分钟
- 尝试3次失败后账户临时锁定5分钟

---

### 15. withdrawal_freeze_log（提现冻结日志表）

**用途**: 监控和记录冻结/解冻过程

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 日志ID |
| user_id | BIGINT | Index | 用户ID |
| order_id | BIGINT | Index | 提现订单ID |
| amount | NUMERIC(65, 30) | NOT NULL | 冻结金额 |
| frozen_at | TIMESTAMPTZ | Index | 冻结时间 |
| released_at | TIMESTAMPTZ | | 解冻时间 |
| reason | VARCHAR(64) | Index | 解冻原因: SUCCESS/FAILED/TIMEOUT |
| created_at | TIMESTAMPTZ | DEFAULT NOW | 创建时间 |

**关键说明**:
- 记录每次冻结和解冻的完整过程
- reason 说明解冻原因：SUCCESS(提币成功), FAILED(提币失败), TIMEOUT(超时自动解冻)

---

## 审计和风控表

### 16. audit_trail（审计日志表）

**用途**: 记录所有重要操作，用于审计和合规

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 审计日志ID |
| operator_id | VARCHAR(64) | Index | 操作者ID |
| operator_role | VARCHAR(32) | | 操作者角色 |
| action | VARCHAR(64) | Index | 操作类型: PRODUCT_LAUNCH, USER_FREEZE, MANUAL_ADJUSTMENT等 |
| target_id | BIGINT | Index | 目标ID（product_id, user_id等） |
| target_type | VARCHAR(32) | | 目标类型: PRODUCT, USER, ACCOUNT等 |
| old_value | JSONB | | 修改前的值 |
| new_value | JSONB | | 修改后的值 |
| reason | TEXT | | 操作原因 |
| ip_address | VARCHAR(45) | | 操作IP地址 |
| status | VARCHAR(32) | Index | 操作结果: SUCCESS, FAILED |
| error_message | VARCHAR(255) | | 错误信息 |
| created_at | TIMESTAMPTZ | DEFAULT NOW | 创建时间 |

---

### 17. risk_alert（风险告警表）

**用途**: 记录系统检测到的风险告警

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 告警ID |
| alert_type | VARCHAR(64) | Index | 告警类型: BALANCE_MISMATCH, FROZEN_BALANCE_HIGH, STALE_REQUEST等 |
| severity | VARCHAR(32) | Index | 告警等级: INFO, WARNING, CRITICAL |
| user_id | BIGINT | | 关联用户ID（可选） |
| target_id | BIGINT | | 关联目标ID |
| target_type | VARCHAR(32) | | 目标类型 |
| message | TEXT | NOT NULL | 告警信息 |
| alert_data | JSONB | | 告警数据 |
| status | VARCHAR(32) | Index | 状态: OPEN, ACKNOWLEDGED, RESOLVED |
| resolved_at | TIMESTAMPTZ | | 解决时间 |
| resolution_notes | TEXT | | 解决备注 |
| created_at | TIMESTAMPTZ | DEFAULT NOW | 创建时间 |

---

### 18. user_notification（用户通知表）

**用途**: 记录发送给用户的各类通知

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 通知ID |
| user_id | BIGINT | Index | 用户ID |
| title | VARCHAR(255) | NOT NULL | 通知标题 |
| message | TEXT | NOT NULL | 通知内容 |
| type | VARCHAR(64) | Index | 通知类型: WITHDRAWAL_TIMEOUT, REDEMPTION_SUCCESS, INTEREST_PAYOUT等 |
| read_at | TIMESTAMPTZ | Index | 已读时间 |
| created_at | TIMESTAMPTZ | DEFAULT NOW | 创建时间 |

---

## 关键字段说明

### frozen_balance（冻结余额）

**用途**: 提现流程的冻结机制

**工作原理**:
```
用户点击提现 1000 USDT（balance = 2000）
  ↓
冻结 1000：frozen_balance = 1000
用户可用余额 = 2000 - 1000 = 1000
  ↓
调用 Safeheron 成功
  ↓
扣款 + 清除冻结：
  balance = 2000 - 1000 = 1000
  frozen_balance = 0
  用户可用余额 = 1000
```

**三个保护作用**:
1. 防止重复提现：用户多次点击，金额只冻结一次
2. 防止余额被其他操作扣除：冻结期间，该金额对申购等其他操作不可见
3. 自动恢复机制：失败立即解冻，超时自动解冻（定时任务），无需人工干预

### version（乐观锁版本号）

**用途**: 防止并发超扣

**更新语句示例**:
```sql
UPDATE account
SET balance = balance - ?,
    frozen_balance = frozen_balance - ?,
    version = version + 1
WHERE id = ? AND version = ? AND balance >= ?
```

### status 枚举字段

**withdrawal_order 的 status**:
- PENDING: 待提交
- VERIFYING: 身份验证中
- SENT: 已发送至链
- CONFIRMING: 链上确认中
- CONFIRMED: 已确认
- COMPLETED: 已完成
- FAILED: 提币失败
- CANCELLED: 已取消
- TIMEOUT: 已超时（冻结已解冻）

---

## 验证清单

- [x] 所有表都有主键 (BIGSERIAL)
- [x] 所有时间字段都有 DEFAULT CURRENT_TIMESTAMP (TIMESTAMPTZ)
- [x] 所有金额字段都使用 NUMERIC(65,30)
- [x] frozen_balance 在 account 表中定义
- [x] 所有高频查询字段都有索引
- [x] 所有 unique 字段都有 unique key
- [x] 所有表都有中英文注释
- [x] 脚本可以直接执行（PostgreSQL 兼容）
- [x] 各表之间的关键字段名一致（如 user_id）
- [x] 冻结机制的相关字段完整（frozen_balance, withdrawal_freeze_log）

---

**文档完成日期**: 2026-01-09
**下一步**: 执行建表脚本，初始化数据库
