# 用户认证数据库表 - 快速参考

## 📊 核心发现总结

### 用户认证使用的表

| 表名 | 用途 | 字段数 | 关键字段 |
|------|------|--------|---------|
| **users** | 用户认证和基本信息 | 7 | email (UNIQUE), password (bcryptjs) |

### 认证流程涉及的表

| 操作 | 涉及表 | 关键字段 | SQL 操作 |
|------|--------|---------|---------|
| **注册** | `users` | email, password | INSERT |
| **登陆** | `users` | email, password | SELECT, bcryptjs.compare |
| **2FA验证** | `users` | twoFactorSecret | SELECT |
| **令牌生成** | (无) | (JWT in-memory) | jwt.sign() |

---

## 🗄️ 数据库环境

### Neon PostgreSQL 配置

**主机**: `ep-bold-cloud-adfpuk12-pooler.c-2.us-east-1.aws.neon.tech`
**数据库**: `neondb`
**地区**: US-East-1 (AWS)
**连接**: SSL required, 1 connection pool

### 现有表（已在 Neon 中）

```
✅ users                    (认证用户)
✅ lendingPositions         (借贷订单)
✅ withdrawalAddresses      (提币地址)
✅ addressVerifications     (地址验证)
✅ withdrawals              (提现交易)
```

### 待添加的表（从财富管理系统）

```
⏳ account                  (用户账户)
⏳ account_journal          (资金流水)
⏳ wealth_product          (理财产品)
⏳ wealth_order            (理财订单)
⏳ wealth_interest_record  (计息记录)
⏳ idempotency_record      (幂等性)
⏳ withdrawal_order        (扩展版本)
... 等 15 个表
```

---

## 🔐 安全实现细节

| 安全措施 | 实现 | 强度 |
|---------|------|------|
| 密码哈希 | bcryptjs (10 rounds) | 🟢 强 |
| 认证令牌 | JWT (24h expiry) | 🟢 强 |
| 2FA | TOTP + 10 备份码 | 🟢 强 |
| 速率限制 | 5 req/60s per IP | 🟢 强 |
| 密钥加密 | AES-256 (2FA) | 🟢 强 |
| 最短密码 | 6 字符 | 🟡 中等 |
| 用户枚举防护 | 通用错误信息 | 🟢 强 |

---

## 📁 关键文件位置

### 认证实现

| 文件 | 行数 | 功能 |
|------|------|------|
| `src/lib/auth-service.ts` | 121 | 核心认证逻辑 |
| `src/lib/auth-middleware.ts` | - | Token 验证 |
| `src/lib/two-factor-service.ts` | - | 2FA 实现 |
| `api/auth/register.ts` | 39 | 注册端点 |
| `api/auth/login.ts` | 39 | 登陆端点 |

### 数据库配置

| 文件 | 功能 |
|------|------|
| `src/db/schema.ts` | Drizzle ORM 表定义 |
| `src/lib/db.ts` | Neon 连接配置 |
| `drizzle.config.ts` | Drizzle 工具配置 |
| `.env` | DATABASE_URL + 凭证 |
| `cmd/db_migration/main.go` | SQL 迁移运行器 |

---

## 🚀 立即行动清单

### 第 1 天：验证现有系统
- [ ] 测试注册端点: `POST /api/auth/register`
- [ ] 测试登陆端点: `POST /api/auth/login`
- [ ] 验证 Neon 数据库连接
- [ ] 运行认证测试: `npm test`

### 第 2-3 天：添加理财系统表
- [ ] 在 `src/db/schema.ts` 中定义 22 个新表
- [ ] 生成 Drizzle 迁移: `npx drizzle-kit generate:pg`
- [ ] 审查迁移脚本
- [ ] 推送到 Neon: `npx drizzle-kit push:pg`

### 第 4-5 天：实现冻结机制和对账
- [ ] 实现冻结/解冻逻辑
- [ ] 编写定时任务（自动解冻、每日对账）
- [ ] 实现幂等性保护
- [ ] 编写集成测试

---

## 📋 表结构对比：现有 vs 计划

### 现有认证系统（5 个表）
```
users
  ├─ lendingPositions (一对多)
  ├─ withdrawalAddresses (一对多)
  │   └─ addressVerifications (一对多)
  └─ withdrawals (一对多)
```

### 完整财富管理系统（27 个表）
```
users (认证中心)
  ├─ account (资产账户)
  │   ├─ account_journal (不可变流水)
  │   └─ wealth_order (理财订单)
  │       └─ wealth_interest_record (计息记录)
  │
  ├─ withdrawal_order (提现订单)
  │   ├─ withdrawal_freeze_log (冻结日志)
  │   └─ withdrawal_address_whitelist (地址白名单)
  │
  └─ [审核、对账、幂等性等 15 个表]
```

---

## 💡 重要发现

### ✅ 优势
- 现有的认证系统实现完整，安全性高
- 已使用现代 ORM (Drizzle)，类型安全
- Neon 数据库配置正确，支持 SSL
- 支持 JWT + 2FA 双层认证

### ⚠️ 需要改进
- 密码最短 6 字符（建议 8-12）
- 当前只有 5 个表，需添加 22 个新表
- Go 后端重写仅有框架，服务未实现
- 冻结机制的定时任务还未实现

### 🔴 阻塞项
- 理财系统的 22 个表未在 Neon 中创建
- 财务对账系统未实现
- 冻结和自动解冻机制未实现

---

## 📞 联系方式

**完整分析文档**:
`docs/静态理财/需求文档MD/认证表设计与Neon数据库分析.md`

**相关文档**:
- `docs/静态理财/需求文档MD/用户提现功能PRD.md`
- `docs/静态理财/需求文档MD/理财账户系统设计.md`
- `docs/静态理财/需求文档MD/数据库建表脚本.sql`

---

**分析完成**: 2026-01-09
**分析工具**: Claude Code + Drizzle Kit + PostgreSQL
**部署环境**: Neon Serverless PostgreSQL (AWS US-East-1)
